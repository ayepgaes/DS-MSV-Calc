name: Build Docker Image

on:
  push:
    branches:
      - main
      - Dockerizaci√≥n  # Permite probar el workflow en esta rama
  workflow_dispatch:  # Permite ejecuci√≥n manual desde cualquier rama

env:
  IMAGE_NAME: calculadora-backend
  REGISTRY: ghcr.io

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout c√≥digo
        uses: actions/checkout@v4

      - name: Configurar owner en min√∫sculas
        id: set-owner
        run: |
          OWNER_LOWER=$(echo "${{ github.repository_owner }}" | tr '[:upper:]' '[:lower:]')
          echo "owner_lower=$OWNER_LOWER" >> $GITHUB_OUTPUT
          echo "Owner en min√∫sculas: $OWNER_LOWER"

      - name: Configurar Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Iniciar sesi√≥n en GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extraer metadatos (etiquetas, etiquetas) para Docker
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ steps.set-owner.outputs.owner_lower }}/${{ env.IMAGE_NAME }}
          tags: |
            type=ref,event=branch
            type=ref,event=pr
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=sha,prefix={{branch}}-
            type=raw,value=latest,enable={{is_default_branch}}

      - name: Construir imagen Docker multi-arquitectura
        id: build
        uses: docker/build-push-action@v5
        with:
          context: ./CalculatorBackendSpringbootProject
          file: ./CalculatorBackendSpringbootProject/Dockerfile
          platforms: linux/amd64,linux/arm64
          push: true
          tags: ${{ env.REGISTRY }}/${{ steps.set-owner.outputs.owner_lower }}/${{ env.IMAGE_NAME }}:test-${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  health-check:
    runs-on: ubuntu-latest
    needs: build
    permissions:
      contents: read
      packages: read

    steps:
      - name: Iniciar sesi√≥n en GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Ejecutar contenedor para health check
        run: |
          OWNER_LOWER=$(echo "${{ github.repository_owner }}" | tr '[:upper:]' '[:lower:]')
          TEST_IMAGE="${{ env.REGISTRY }}/$OWNER_LOWER/${{ env.IMAGE_NAME }}:test-${{ github.sha }}"
          docker pull $TEST_IMAGE
          docker run -d -p 8080:8080 --name calculadora-backend-test $TEST_IMAGE
          echo "Contenedor iniciado, esperando a que la aplicaci√≥n est√© lista..."

      - name: Esperar a que la aplicaci√≥n est√© lista
        run: |
          echo "Esperando a que el servicio est√© disponible en /actuator/health..."
          timeout=60
          counter=0
          
          while [ $counter -lt $timeout ]; do
            http_code=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:8080/actuator/health 2>/dev/null || echo "000")
            if [ "$http_code" = "200" ]; then
              echo "‚úÖ Servicio disponible en /actuator/health"
              break
            fi
            
            echo "Intento $counter/$timeout: Esperando servicio... (c√≥digo HTTP: $http_code)"
            sleep 2
            counter=$((counter + 2))
          done
          
          if [ $counter -ge $timeout ]; then
            echo "‚ùå Timeout: El servicio no respondi√≥ a tiempo"
            docker logs calculadora-backend-test
            exit 1
          fi

      - name: Health Check - Verificar endpoint /actuator/health
        run: |
          echo "Realizando health check en /actuator/health..."
          
          response=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:8080/actuator/health || echo "000")
          body=$(curl -s http://localhost:8080/actuator/health || echo "")
          
          echo "C√≥digo de respuesta HTTP: $response"
          echo "Cuerpo de respuesta: $body"
          
          # Verificar c√≥digo HTTP 200
          if [ "$response" != "200" ]; then
            echo "‚ùå Health check fall√≥: C√≥digo HTTP $response (esperado 200)"
            docker logs calculadora-backend-test
            docker stop calculadora-backend-test
            docker rm calculadora-backend-test
            exit 1
          fi
          
          # Verificar que el cuerpo contenga "status":"UP"
          if ! echo "$body" | grep -q '"status":"UP"'; then
            echo "‚ùå Health check fall√≥: El cuerpo no contiene '\"status\":\"UP\"'"
            echo "Cuerpo recibido: $body"
            docker logs calculadora-backend-test
            docker stop calculadora-backend-test
            docker rm calculadora-backend-test
            exit 1
          fi
          
          # Verificar que contenga los grupos liveness y readiness (opcional pero recomendado)
          if echo "$body" | grep -q '"groups":\["liveness","readiness"\]'; then
            echo "‚úÖ Health check exitoso: Servicio respondi√≥ 200 OK con status UP y grupos liveness/readiness"
          elif echo "$body" | grep -q '"groups"'; then
            echo "‚úÖ Health check exitoso: Servicio respondi√≥ 200 OK con status UP y grupos configurados"
          else
            echo "‚úÖ Health check exitoso: Servicio respondi√≥ 200 OK con status UP"
          fi
          
          echo "‚úÖ Validaci√≥n completada: El endpoint /actuator/health responde correctamente"

      - name: Detener contenedor de prueba
        if: always()
        run: |
          docker stop calculadora-backend-test || true
          docker rm calculadora-backend-test || true

  publish:
    runs-on: ubuntu-latest
    needs: [build, health-check]
    permissions:
      contents: read
      packages: write

    steps:
      - name: Iniciar sesi√≥n en GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Configurar owner en min√∫sculas
        id: set-owner
        run: |
          OWNER_LOWER=$(echo "${{ github.repository_owner }}" | tr '[:upper:]' '[:lower:]')
          echo "owner_lower=$OWNER_LOWER" >> $GITHUB_OUTPUT
          echo "Owner en min√∫sculas: $OWNER_LOWER"

      - name: Extraer metadatos (etiquetas, etiquetas) para Docker
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ steps.set-owner.outputs.owner_lower }}/${{ env.IMAGE_NAME }}
          tags: |
            type=ref,event=branch
            type=ref,event=pr
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=sha,prefix={{branch}}-
            type=raw,value=latest,enable={{is_default_branch}}

      - name: Configurar Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Re-taggear y publicar imagen (sin reconstruir)
        run: |
          SOURCE_IMAGE="${{ env.REGISTRY }}/${{ steps.set-owner.outputs.owner_lower }}/${{ env.IMAGE_NAME }}:test-${{ github.sha }}"
          
          # Obtener los tags finales (separados por comas)
          TAGS="${{ steps.meta.outputs.tags }}"
          
          # Usar docker buildx imagetools para crear tags apuntando a la imagen existente
          echo "$TAGS" | tr ',' '\n' | while read -r tag; do
            tag=$(echo "$tag" | xargs)  # Trim whitespace
            if [ -n "$tag" ]; then
              echo "Re-taggeando imagen a: $tag"
              # buildx imagetools create crea un tag apuntando a la imagen existente sin reconstruir
              docker buildx imagetools create -t "$tag" "$SOURCE_IMAGE"
            fi
          done

      - name: Mostrar informaci√≥n de la imagen
        run: |
          echo "‚úÖ Imagen construida y verificada exitosamente:"
          echo "Tags: ${{ steps.meta.outputs.tags }}"
          echo "Puedes acceder a la imagen en: ${{ env.REGISTRY }}/${{ steps.set-owner.outputs.owner_lower }}/${{ env.IMAGE_NAME }}"

  cleanup:
    runs-on: ubuntu-latest
    needs: [build, health-check]
    if: always() && (needs.health-check.result == 'failure' || needs.health-check.result == 'cancelled')
    permissions:
      contents: read
      packages: write

    steps:
      - name: Eliminar imagen temporal (health-check fall√≥)
        run: |
          echo "üßπ Limpiando imagen temporal porque el health-check fall√≥ o fue cancelado"
          
          # Obtener el ID de la versi√≥n del paquete usando el tag
          PACKAGE_NAME="${{ env.IMAGE_NAME }}"
          TAG="test-${{ github.sha }}"
          OWNER=$(echo "${{ github.repository_owner }}" | tr '[:upper:]' '[:lower:]')
          
          echo "Buscando versi√≥n del paquete con tag: $TAG"
          
          # Obtener todas las versiones del paquete y buscar la que tiene nuestro tag
          VERSIONS=$(curl -s \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/orgs/$OWNER/packages/container/$PACKAGE_NAME/versions")
          
          # Buscar el ID de la versi√≥n que tiene nuestro tag
          VERSION_ID=$(echo "$VERSIONS" | grep -B 5 "\"name\":\"$TAG\"" | grep "\"id\"" | head -1 | sed 's/.*"id": \([0-9]*\).*/\1/')
          
          if [ -n "$VERSION_ID" ]; then
            echo "Eliminando versi√≥n con ID: $VERSION_ID"
            curl -X DELETE \
              -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
              -H "Accept: application/vnd.github.v3+json" \
              "https://api.github.com/orgs/$OWNER/packages/container/$PACKAGE_NAME/versions/$VERSION_ID" \
              && echo "‚úÖ Imagen temporal eliminada exitosamente" \
              || echo "‚ö†Ô∏è No se pudo eliminar la imagen (puede requerir permisos adicionales)"
          else
            echo "‚ö†Ô∏è No se encontr√≥ la versi√≥n con tag $TAG (puede que ya haya sido eliminada)"
          fi

