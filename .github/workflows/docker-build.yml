name: Build Docker Image

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  IMAGE_NAME: calculadora-backend
  REGISTRY: ghcr.io

concurrency:
  group: docker-build-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout c√≥digo
        uses: actions/checkout@v4

      - name: Configurar owner en min√∫sculas
        id: set-owner
        run: |
          OWNER_LOWER=$(echo "${{ github.repository_owner }}" | tr '[:upper:]' '[:lower:]')
          echo "owner_lower=$OWNER_LOWER" >> $GITHUB_OUTPUT
          echo "Owner en min√∫sculas: $OWNER_LOWER"

      - name: Configurar Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Iniciar sesi√≥n en GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extraer metadatos (etiquetas, etiquetas) para Docker
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ steps.set-owner.outputs.owner_lower }}/${{ env.IMAGE_NAME }}
          tags: |
            type=ref,event=branch
            type=ref,event=pr
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=sha,prefix={{branch}}-
            type=raw,value=latest,enable={{is_default_branch}}

      - name: Construir imagen Docker multi-arquitectura
        id: build
        uses: docker/build-push-action@v5
        with:
          context: ./CalculatorBackendSpringbootProject
          file: ./CalculatorBackendSpringbootProject/Dockerfile
          platforms: linux/amd64,linux/arm64
          push: true
          tags: ${{ env.REGISTRY }}/${{ steps.set-owner.outputs.owner_lower }}/${{ env.IMAGE_NAME }}:test-${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  health-check:
    runs-on: ubuntu-latest
    needs: build
    permissions:
      contents: read
      packages: read

    steps:
      - name: Iniciar sesi√≥n en GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Ejecutar contenedor para health check
        run: |
          OWNER_LOWER=$(echo "${{ github.repository_owner }}" | tr '[:upper:]' '[:lower:]')
          TEST_IMAGE="${{ env.REGISTRY }}/$OWNER_LOWER/${{ env.IMAGE_NAME }}:test-${{ github.sha }}"
          docker pull $TEST_IMAGE
          docker run -d -p 8080:8080 --name calculadora-backend-test $TEST_IMAGE
          echo "Contenedor iniciado, esperando a que la aplicaci√≥n est√© lista..."

      - name: Esperar a que la aplicaci√≥n est√© lista
        run: |
          echo "Esperando a que el servicio est√© disponible en /actuator/health..."
          timeout=60
          counter=0
          
          while [ $counter -lt $timeout ]; do
            http_code=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:8080/actuator/health 2>/dev/null || echo "000")
            if [ "$http_code" = "200" ]; then
              echo "‚úÖ Servicio disponible en /actuator/health"
              break
            fi
            
            echo "Intento $counter/$timeout: Esperando servicio... (c√≥digo HTTP: $http_code)"
            sleep 2
            counter=$((counter + 2))
          done
          
          if [ $counter -ge $timeout ]; then
            echo "‚ùå Timeout: El servicio no respondi√≥ a tiempo"
            docker logs calculadora-backend-test
            exit 1
          fi

      - name: Health Check - Verificar endpoint /actuator/health
        run: |
          echo "Realizando health check en /actuator/health..."
          
          response=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:8080/actuator/health || echo "000")
          body=$(curl -s http://localhost:8080/actuator/health || echo "")
          
          echo "C√≥digo de respuesta HTTP: $response"
          echo "Cuerpo de respuesta: $body"
          
          # Verificar c√≥digo HTTP 200
          if [ "$response" != "200" ]; then
            echo "‚ùå Health check fall√≥: C√≥digo HTTP $response (esperado 200)"
            docker logs calculadora-backend-test
            docker stop calculadora-backend-test
            docker rm calculadora-backend-test
            exit 1
          fi
          
          # Verificar que el cuerpo contenga "status":"UP"
          if ! echo "$body" | grep -q '"status":"UP"'; then
            echo "‚ùå Health check fall√≥: El cuerpo no contiene '\"status\":\"UP\"'"
            echo "Cuerpo recibido: $body"
            docker logs calculadora-backend-test
            docker stop calculadora-backend-test
            docker rm calculadora-backend-test
            exit 1
          fi
          
          # Verificar que contenga los grupos liveness y readiness (opcional pero recomendado)
          if echo "$body" | grep -q '"groups":\["liveness","readiness"\]'; then
            echo "‚úÖ Health check exitoso: Servicio respondi√≥ 200 OK con status UP y grupos liveness/readiness"
          elif echo "$body" | grep -q '"groups"'; then
            echo "‚úÖ Health check exitoso: Servicio respondi√≥ 200 OK con status UP y grupos configurados"
          else
            echo "‚úÖ Health check exitoso: Servicio respondi√≥ 200 OK con status UP"
          fi
          
          echo "‚úÖ Validaci√≥n completada: El endpoint /actuator/health responde correctamente"

      - name: Detener contenedor de prueba
        if: always()
        run: |
          docker stop calculadora-backend-test || true
          docker rm calculadora-backend-test || true

  test:
    runs-on: ubuntu-latest
    needs: health-check
    permissions:
      contents: read

    steps:
      - name: Checkout c√≥digo
        uses: actions/checkout@v4

      - name: Configurar Java 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: maven

      - name: Ejecutar tests
        working-directory: ./CalculatorBackendSpringbootProject
        run: mvn test

      - name: Subir reportes de tests como artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-reports
          path: |
            CalculatorBackendSpringbootProject/target/surefire-reports/**
            CalculatorBackendSpringbootProject/target/site/surefire-report.html
          if-no-files-found: ignore
          retention-days: 7

  security-scan:
    runs-on: ubuntu-latest
    needs: [build, health-check, test]
    permissions:
      contents: read
      packages: read
      security-events: write
      id-token: write

    steps:
      - name: Iniciar sesi√≥n en GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Configurar owner en min√∫sculas
        id: set-owner
        run: |
          OWNER_LOWER=$(echo "${{ github.repository_owner }}" | tr '[:upper:]' '[:lower:]')
          echo "owner_lower=$OWNER_LOWER" >> $GITHUB_OUTPUT
          echo "Owner en min√∫sculas: $OWNER_LOWER"

      - name: Ejecutar escaneo de vulnerabilidades con Snyk
        uses: snyk/actions/docker@master
        continue-on-error: true
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          image: ${{ env.REGISTRY }}/${{ steps.set-owner.outputs.owner_lower }}/${{ env.IMAGE_NAME }}:test-${{ github.sha }}
          args: |
            --severity-threshold=high
            --json-file-output=snyk-results.json
            --sarif-file-output=snyk-results.sarif

      - name: Verificar archivos generados por Snyk
        run: |
          echo "üìÅ Verificando archivos generados por Snyk..."
          ls -la *.json *.sarif 2>/dev/null || echo "No se encontraron archivos de resultados"
          if [ -f snyk-results.json ]; then
            echo "‚úÖ Archivo JSON encontrado"
          else
            echo "‚ö†Ô∏è Archivo JSON no encontrado"
          fi
          if [ -f snyk-results.sarif ]; then
            echo "‚úÖ Archivo SARIF encontrado"
          else
            echo "‚ö†Ô∏è Archivo SARIF no encontrado (puede ser normal si no hay vulnerabilidades)"
          fi

      - name: Procesar resultados de Snyk
        id: snyk-results
        run: |
          if [ -f snyk-results.json ]; then
            echo "üìä Analizando resultados de Snyk..."
            
            # Contar vulnerabilidades por severidad
            CRITICAL=$(jq -r '.vulnerabilities[]? | select(.severity == "critical") | .id' snyk-results.json | sort -u | wc -l | tr -d ' ')
            HIGH=$(jq -r '.vulnerabilities[]? | select(.severity == "high") | .id' snyk-results.json | sort -u | wc -l | tr -d ' ')
            MEDIUM=$(jq -r '.vulnerabilities[]? | select(.severity == "medium") | .id' snyk-results.json | sort -u | wc -l | tr -d ' ')
            LOW=$(jq -r '.vulnerabilities[]? | select(.severity == "low") | .id' snyk-results.json | sort -u | wc -l | tr -d ' ')
            
            echo "üîç Resumen de vulnerabilidades encontradas:"
            echo "  - Cr√≠ticas: $CRITICAL"
            echo "  - Altas: $HIGH"
            echo "  - Medias: $MEDIUM"
            echo "  - Bajas: $LOW"
            
            # Guardar en outputs
            echo "critical=$CRITICAL" >> $GITHUB_OUTPUT
            echo "high=$HIGH" >> $GITHUB_OUTPUT
            echo "medium=$MEDIUM" >> $GITHUB_OUTPUT
            echo "low=$LOW" >> $GITHUB_OUTPUT
            
            # Verificar si existe SARIF
            if [ -f snyk-results.sarif ]; then
              echo "sarif_exists=true" >> $GITHUB_OUTPUT
            else
              echo "sarif_exists=false" >> $GITHUB_OUTPUT
            fi
            
            # Generar reporte detallado
            echo "üìÑ Generando reporte detallado..."
            jq '.' snyk-results.json > snyk-report-detailed.json
            
            # Mostrar vulnerabilidades cr√≠ticas y altas
            if [ "$CRITICAL" -gt 0 ] || [ "$HIGH" -gt 0 ]; then
              echo "‚ö†Ô∏è VULNERABILIDADES CR√çTICAS O ALTAS ENCONTRADAS:"
              echo ""
              jq -r '.vulnerabilities[]? | select(.severity == "critical" or .severity == "high") | "\(.severity | ascii_upcase): \(.title) - \(.packageName)@\(.version)\n  ID: \(.id)\n  Descripci√≥n: \(.description // "Sin descripci√≥n")\n  Enlace: \(.url // "N/A")\n"' snyk-results.json
              echo ""
              echo "‚ùå El escaneo encontr√≥ vulnerabilidades cr√≠ticas o altas. La publicaci√≥n ser√° bloqueada."
              echo "block_publish=true" >> $GITHUB_OUTPUT
            else
              echo "‚úÖ No se encontraron vulnerabilidades cr√≠ticas o altas."
              echo "‚úÖ Solo se encontraron vulnerabilidades de severidad media o baja, que son aceptables."
              echo "block_publish=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "‚ö†Ô∏è No se gener√≥ el archivo de resultados de Snyk"
            echo "block_publish=false" >> $GITHUB_OUTPUT
            echo "critical=0" >> $GITHUB_OUTPUT
            echo "high=0" >> $GITHUB_OUTPUT
            echo "medium=0" >> $GITHUB_OUTPUT
            echo "low=0" >> $GITHUB_OUTPUT
            echo "sarif_exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Subir reporte SARIF a GitHub Security
        uses: github/codeql-action/upload-sarif@v4
        if: always() && steps.snyk-results.outputs.sarif_exists == 'true'
        with:
          sarif_file: snyk-results.sarif
          wait-for-processing: false

      - name: Guardar reporte como artifact
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: snyk-security-report
          path: |
            snyk-results.json
            snyk-report-detailed.json
            snyk-results.sarif
          if-no-files-found: ignore
          retention-days: 30

      - name: Mostrar resumen del escaneo
        if: always()
        run: |
          echo "## üîí Resumen del Escaneo de Seguridad" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Severidad | Cantidad |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|----------|" >> $GITHUB_STEP_SUMMARY
          echo "| üî¥ Cr√≠tica | ${{ steps.snyk-results.outputs.critical }} |" >> $GITHUB_STEP_SUMMARY
          echo "| üü† Alta | ${{ steps.snyk-results.outputs.high }} |" >> $GITHUB_STEP_SUMMARY
          echo "| üü° Media | ${{ steps.snyk-results.outputs.medium }} |" >> $GITHUB_STEP_SUMMARY
          echo "| üü¢ Baja | ${{ steps.snyk-results.outputs.low }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.snyk-results.outputs.block_publish }}" == "true" ]; then
            echo "‚ùå **La publicaci√≥n ha sido bloqueada debido a vulnerabilidades cr√≠ticas o altas.**" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚úÖ **El escaneo pas√≥. Solo se encontraron vulnerabilidades de severidad media o baja.**" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "üìÑ Los reportes detallados est√°n disponibles en los artifacts del workflow." >> $GITHUB_STEP_SUMMARY

      - name: Fallar si hay vulnerabilidades cr√≠ticas o altas
        if: steps.snyk-results.outputs.block_publish == 'true'
        run: |
          echo "‚ùå Bloqueando la publicaci√≥n debido a vulnerabilidades cr√≠ticas o altas encontradas."
          exit 1

  publish:
    runs-on: ubuntu-latest
    needs: [build, health-check, test, security-scan]
    permissions:
      contents: read
      packages: write

    steps:
      - name: Iniciar sesi√≥n en GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Configurar owner en min√∫sculas
        id: set-owner
        run: |
          OWNER_LOWER=$(echo "${{ github.repository_owner }}" | tr '[:upper:]' '[:lower:]')
          echo "owner_lower=$OWNER_LOWER" >> $GITHUB_OUTPUT
          echo "Owner en min√∫sculas: $OWNER_LOWER"

      - name: Extraer metadatos (etiquetas, etiquetas) para Docker
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ steps.set-owner.outputs.owner_lower }}/${{ env.IMAGE_NAME }}
          tags: |
            type=ref,event=branch
            type=ref,event=pr
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=sha,prefix={{branch}}-
            type=raw,value=latest,enable={{is_default_branch}}

      - name: Configurar Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Re-taggear y publicar imagen (sin reconstruir)
        run: |
          SOURCE_IMAGE="${{ env.REGISTRY }}/${{ steps.set-owner.outputs.owner_lower }}/${{ env.IMAGE_NAME }}:test-${{ github.sha }}"
          
          # Obtener los tags finales (separados por comas)
          TAGS="${{ steps.meta.outputs.tags }}"
          
          # Usar docker buildx imagetools para crear tags apuntando a la imagen existente
          echo "$TAGS" | tr ',' '\n' | while read -r tag; do
            tag=$(echo "$tag" | xargs)  # Trim whitespace
            if [ -n "$tag" ]; then
              echo "Re-taggeando imagen a: $tag"
              # buildx imagetools create crea un tag apuntando a la imagen existente sin reconstruir
              docker buildx imagetools create -t "$tag" "$SOURCE_IMAGE"
            fi
          done

      - name: Mostrar informaci√≥n de la imagen
        run: |
          echo "‚úÖ Imagen construida y verificada exitosamente:"
          echo "Tags: ${{ steps.meta.outputs.tags }}"
          echo "Puedes acceder a la imagen en: ${{ env.REGISTRY }}/${{ steps.set-owner.outputs.owner_lower }}/${{ env.IMAGE_NAME }}"

  cleanup:
    runs-on: ubuntu-latest
    needs: [build, health-check, test, security-scan]
    if: always() && (needs.health-check.result == 'failure' || needs.health-check.result == 'cancelled' || needs.test.result == 'failure' || needs.test.result == 'cancelled' || needs.security-scan.result == 'failure' || needs.security-scan.result == 'cancelled')
    permissions:
      contents: read
      packages: write

    steps:
      - name: Eliminar imagen temporal (fallo en validaciones)
        run: |
          REASON=""
          if [ "${{ needs.health-check.result }}" == "failure" ] || [ "${{ needs.health-check.result }}" == "cancelled" ]; then
            REASON="health-check"
          fi
          if [ "${{ needs.test.result }}" == "failure" ] || [ "${{ needs.test.result }}" == "cancelled" ]; then
            if [ -n "$REASON" ]; then
              REASON="$REASON y test"
            else
              REASON="test"
            fi
          fi
          if [ "${{ needs.security-scan.result }}" == "failure" ] || [ "${{ needs.security-scan.result }}" == "cancelled" ]; then
            if [ -n "$REASON" ]; then
              REASON="$REASON y security-scan"
            else
              REASON="security-scan"
            fi
          fi
          echo "üßπ Limpiando imagen temporal porque $REASON fall√≥ o fue cancelado"
          
          # Obtener el ID de la versi√≥n del paquete usando el tag
          PACKAGE_NAME="${{ env.IMAGE_NAME }}"
          TAG="test-${{ github.sha }}"
          OWNER=$(echo "${{ github.repository_owner }}" | tr '[:upper:]' '[:lower:]')
          
          echo "Buscando versi√≥n del paquete con tag: $TAG"
          
          # Obtener todas las versiones del paquete y buscar la que tiene nuestro tag
          VERSIONS=$(curl -s \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/orgs/$OWNER/packages/container/$PACKAGE_NAME/versions")
          
          # Buscar el ID de la versi√≥n que tiene nuestro tag
          VERSION_ID=$(echo "$VERSIONS" | grep -B 5 "\"name\":\"$TAG\"" | grep "\"id\"" | head -1 | sed 's/.*"id": \([0-9]*\).*/\1/')
          
          if [ -n "$VERSION_ID" ]; then
            echo "Eliminando versi√≥n con ID: $VERSION_ID"
            curl -X DELETE \
              -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
              -H "Accept: application/vnd.github.v3+json" \
              "https://api.github.com/orgs/$OWNER/packages/container/$PACKAGE_NAME/versions/$VERSION_ID" \
              && echo "‚úÖ Imagen temporal eliminada exitosamente" \
              || echo "‚ö†Ô∏è No se pudo eliminar la imagen (puede requerir permisos adicionales)"
          else
            echo "‚ö†Ô∏è No se encontr√≥ la versi√≥n con tag $TAG (puede que ya haya sido eliminada)"
          fi

